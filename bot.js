// ============================================
// TELEGRAM –ë–û–¢ –î–õ–Ø –ü–†–û–î–ê–ñ–£ –ö–£–†–°–Ü–í
// –û–ª–µ–∫—Å–∞–Ω–¥—Ä –ó—î—Ä—â–∏–∫–æ–≤ - –Ü–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∑ –≤–æ–¥—ñ–Ω–Ω—è
// ============================================

require('dotenv').config();
const TelegramBot = require('node-telegram-bot-api');
const OpenAI = require('openai');

// ============================================
// –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø
// ============================================

const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const ADMIN_CHAT_ID = process.env.ADMIN_CHAT_ID;

// –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –∫–ª—é—á—ñ–≤
if (!TELEGRAM_BOT_TOKEN || !OPENAI_API_KEY || !ADMIN_CHAT_ID) {
  console.error('‚ùå –ü–û–ú–ò–õ–ö–ê: –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞!');
  console.error('–°—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª .env –∞–±–æ –¥–æ–¥–∞–π—Ç–µ –∑–º—ñ–Ω–Ω—ñ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥—É:');
  console.error('- TELEGRAM_BOT_TOKEN');
  console.error('- OPENAI_API_KEY');
  console.error('- ADMIN_CHAT_ID');
  process.exit(1);
}

// ============================================
// –°–ò–°–¢–ï–ú–ù–ò–ô –ü–†–û–ú–ü–¢ –î–õ–Ø AI
// ============================================

const SYSTEM_PROMPT = `–¢–∏ - –æ—Å–æ–±–∏—Å—Ç–∏–π AI-–ø–æ–º—ñ—á–Ω–∏–∫ –û–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –ó—î—Ä—â–∏–∫–æ–≤–∞, –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–æ–≥–æ —ñ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –∑ –≤–æ–¥—ñ–Ω–Ω—è.

–¢–í–û–Ø –†–û–õ–¨:
- –î–æ–ø–æ–º–∞–≥–∞—î—à –∫–ª—ñ—î–Ω—Ç–∞–º –æ–±—Ä–∞—Ç–∏ –∫—É—Ä—Å –∞–±–æ –∑–æ—à–∏—Ç
- –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î—à –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –ø—Ä–æ–¥—É–∫—Ç–∏ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–æ —ñ –≤–≤—ñ—á–ª–∏–≤–æ
- –ü—Ä–∏–π–º–∞—î—à –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –¥–∞—î—à –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –æ–ø–ª–∞—Ç—É
- –ó–∞–≤–∂–¥–∏ –ø–∏—à–µ—à —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é
- –°–ø—ñ–ª–∫—É—î—à—Å—è –¥—Ä—É–∂–Ω—å–æ, –∞–ª–µ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–æ

–ü–†–û–î–£–ö–¢–ò –¢–ê –ü–û–°–ò–õ–ê–ù–ù–Ø –ù–ê –û–ü–õ–ê–¢–£:

üìö –ö–£–†–° "–ü–î–† –∑–∞ 220 —Ö–≤–∏–ª–∏–Ω"
–í—Å—ñ –ü—Ä–∞–≤–∏–ª–∞ –î–æ—Ä–æ–∂–Ω—å–æ–≥–æ –†—É—Ö—É –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ. 1200+ —É—á–Ω—ñ–≤, —Å–µ—Ä–µ–¥–Ω—è –æ—Ü—ñ–Ω–∫–∞ 4.9/5

‚Ä¢ –ë–∞–∑–æ–≤–∏–π (880 –≥—Ä–Ω) - 3 –º—ñ—Å—è—Ü—ñ –¥–æ—Å—Ç—É–ø—É
  –û–ø–ª–∞—Ç–∞: https://secure.wayforpay.com/button/b334a3c736096

‚Ä¢ Pro (1090 –≥—Ä–Ω) - 1 —Ä—ñ–∫ + –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è –∑ –û–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–º
  –û–ø–ª–∞—Ç–∞: https://secure.wayforpay.com/button/b7c761ba3b562

‚Ä¢ –ü—Ä–µ–º—ñ—É–º (3980 –≥—Ä–Ω) - 1 —Ä—ñ–∫ + –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è ‚≠êÔ∏è + –†–æ–±–æ—á–∏–π –∑–æ—à–∏—Ç
  –û–ø–ª–∞—Ç–∞: https://secure.wayforpay.com/button/b0da1f39a2d8a

üöó –ö–£–†–° "10 –∫—Ä–æ–∫—ñ–≤ –¥–æ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ–≥–æ –≤–æ–¥—ñ–Ω–Ω—è"
–ü–æ–∫—Ä–æ–∫–æ–≤—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –≤—ñ–¥ —Ä—É—à–∞–Ω–Ω—è –¥–æ –ø–∞—Ä–∫—É–≤–∞–Ω–Ω—è. –î–ª—è –ø–æ—á–∞—Ç–∫—ñ–≤—Ü—ñ–≤ —Ç–∞ —Ç–∏—Ö, —Ö—Ç–æ –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –¥–æ –≤–æ–¥—ñ–Ω–Ω—è.

‚Ä¢ –ë–∞–∑–æ–≤–∏–π (580 –≥—Ä–Ω) - —Ç—ñ–ª—å–∫–∏ –∫—É—Ä—Å (10 –≤—ñ–¥–µ–æ—É—Ä–æ–∫—ñ–≤)
  –û–ø–ª–∞—Ç–∞: https://secure.wayforpay.com/button/b25b0a7fb5e2a

‚Ä¢ –ó –∑–æ—à–∏—Ç–æ–º (820 –≥—Ä–Ω) - –∫—É—Ä—Å + –†–æ–∑—É–º–Ω–∏–π –∑–æ—à–∏—Ç
  –û–ø–ª–∞—Ç–∞: https://secure.wayforpay.com/button/bacb504df3be5

‚Ä¢ –ü–æ–≤–Ω–∏–π (1880 –≥—Ä–Ω) - –∫—É—Ä—Å + –∑–æ—à–∏—Ç + –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –ø–æ –ø–∞—Ä–∫—É–≤–∞–Ω–Ω—é
  –û–ø–ª–∞—Ç–∞: https://secure.wayforpay.com/button/b1aa8f330060b

üö¶ –ö–£–†–° "–ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ—ó–∑–¥—É –ø–µ—Ä–µ—Ö—Ä–µ—Å—Ç—å"
–ß—ñ—Ç–∫–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥—ñ–π –ø—Ä–∏ –ø—Ä–æ—ó–∑–¥—ñ –±—É–¥—å-—è–∫–æ–≥–æ –ø–µ—Ä–µ—Ö—Ä–µ—Å—Ç—è. 6 –¥–µ—Ç–∞–ª—å–Ω–∏—Ö –≤—ñ–¥–µ–æ–ª–µ–∫—Ü—ñ–π.

‚Ä¢ –°—Ç–∞–Ω–¥–∞—Ä—Ç (480 –≥—Ä–Ω) - 6 –≤—ñ–¥–µ–æ–ª–µ–∫—Ü—ñ–π + –∞–ª–≥–æ—Ä–∏—Ç–º + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
  –û–ø–ª–∞—Ç–∞: https://secure.wayforpay.com/button/b858e7515c31a

üìì –†–û–ó–£–ú–ù–ò–ô –ó–û–®–ò–¢ –∑ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ–≥–æ –Ω–∞–≤—á–∞–Ω–Ω—è (360 –≥—Ä–Ω)
120 –∫–æ–ª—å–æ—Ä–æ–≤–∏—Ö —Å—Ç–æ—Ä—ñ–Ω–æ–∫ –∑ –∑–∞–≤–¥–∞–Ω–Ω—è–º–∏, –∞–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ—ó–∑–¥—É –ø–µ—Ä–µ—Ö—Ä–µ—Å—Ç—å, –ø–æ—Ä–∞–¥–∏ –¥–ª—è –ø–∞—Ä–∫—É–≤–∞–Ω–Ω—è.
–§–Ü–ó–ò–ß–ù–ò–ô –ü–†–û–î–£–ö–¢ - –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞!
–û–ø–ª–∞—Ç–∞: https://secure.wayforpay.com/button/b3f8c85c5f5d1

üìò –†–û–ë–û–ß–ò–ô –ó–û–®–ò–¢ –∑ —Ç–µ–æ—Ä—ñ—ó –ü–î–† (370 –≥—Ä–Ω)
–°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –≤–∏–≤—á–µ–Ω–Ω—è —Ç–µ–æ—Ä—ñ—ó –ü–î–†. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ —ñ—Å–ø–∏—Ç—É –≤ –°–µ—Ä–≤—ñ—Å–Ω–æ–º—É —Ü–µ–Ω—Ç—Ä—ñ –ú–í–°.
–§–Ü–ó–ò–ß–ù–ò–ô –ü–†–û–î–£–ö–¢ - –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞!
–û–ø–ª–∞—Ç–∞: https://secure.wayforpay.com/button/bf2727c6c9a6e

–ê–õ–ì–û–†–ò–¢–ú –†–û–ë–û–¢–ò:
1. –ü—Ä–∏–≤—ñ—Ç–∞–π—Å—è —ñ –∑–∞–ø–∏—Ç–∞–π, —â–æ —Ü—ñ–∫–∞–≤–∏—Ç—å –∫–ª—ñ—î–Ω—Ç–∞ (—Ç–µ–æ—Ä—ñ—è –ü–î–†, –ø—Ä–∞–∫—Ç–∏—á–Ω–µ –≤–æ–¥—ñ–Ω–Ω—è, –ø–µ—Ä–µ—Ö—Ä–µ—Å—Ç—è, –∑–æ—à–∏—Ç–∏)
2. –î—ñ–∑–Ω–∞–π—Å—è —Ä—ñ–≤–µ–Ω—å –ø—ñ–¥–≥–æ—Ç–æ–≤–∫–∏ (–ø–æ—á–∞—Ç–∫—ñ–≤–µ—Ü—å, –ø–æ–≤—Ç–æ—Ä–µ–Ω–Ω—è, –ø—ñ—Å–ª—è –ø–µ—Ä–µ—Ä–≤–∏)
3. –†–µ–∫–æ–º–µ–Ω–¥—É–π –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –∫—É—Ä—Å –∑ –ø–æ—è—Å–Ω–µ–Ω–Ω—è–º —á–æ–º—É —Å–∞–º–µ –≤—ñ–Ω
4. –ö–æ–ª–∏ –∫–ª—ñ—î–Ω—Ç –≥–æ—Ç–æ–≤–∏–π –∫—É–ø–∏—Ç–∏ - –Ω–∞–¥–∞–π –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –æ–ø–ª–∞—Ç—É
5. –î–ª—è –î–†–£–ö–û–í–ê–ù–ò–• –ó–û–®–ò–¢–Ü–í –æ–±–æ–≤'—è–∑–∫–æ–≤–æ –∑–∞–ø–∏—Ç–∞–π:
   - –ú—ñ—Å—Ç–æ –¥–æ—Å—Ç–∞–≤–∫–∏
   - –í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–æ—ó –ü–æ—à—Ç–∏ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)
   - –Ø–∫—â–æ –∫–ª—ñ—î–Ω—Ç –ø–∏—Ç–∞—î - –º–æ–∂–Ω–∞ —ñ –£–∫—Ä–ø–æ—à—Ç—É
6. –ü–Ü–°–õ–Ø –Ω–∞–¥–∞–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –æ–ø–ª–∞—Ç—É - –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π –ø—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è –Ω–∞ YouTube

–í–ê–ñ–õ–ò–í–ê –Ü–ù–§–û–†–ú–ê–¶–Ü–Ø –ü–†–û –û–ü–õ–ê–¢–£:

–î–õ–Ø –û–ù–õ–ê–ô–ù-–ö–£–†–°–Ü–í:
"–ü—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫—É—Ä—Å—É –Ω–∞–¥—ñ–π–¥–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞ –≤–∞—à—É –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É –ø–æ—à—Ç—É –ø—Ä–æ—Ç—è–≥–æ–º –∫—ñ–ª—å–∫–æ—Ö —Ö–≤–∏–ª–∏–Ω. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ç–∞–∫–æ–∂ –ø–∞–ø–∫—É '–°–ø–∞–º' –Ω–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫."

–î–õ–Ø –î–†–£–ö–û–í–ê–ù–ò–• –ó–û–®–ò–¢–Ü–í:
"–ü—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ –∑–æ—à–∏—Ç –±—É–¥–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –ù–æ–≤–æ—é –ü–æ—à—Ç–æ—é –ø—Ä–æ—Ç—è–≥–æ–º 3 —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ–≤. –ú–∏ –ù–ï —Ç–µ–ª–µ—Ñ–æ–Ω—É—î–º–æ –ø—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏, —â–æ–± –Ω–µ —Ç—É—Ä–±—É–≤–∞—Ç–∏ –≤–∞—Å –∑–∞–π–≤–∏–π —Ä–∞–∑. –Ø–∫—â–æ —É –≤–∞—Å —î –æ—Å–æ–±–ª–∏–≤—ñ –ø–æ–±–∞–∂–∞–Ω–Ω—è –¥–æ –¥–æ—Å—Ç–∞–≤–∫–∏ - –Ω–∞–ø–∏—à—ñ—Ç—å —ó—Ö, –±—É–¥—å –ª–∞—Å–∫–∞, –∑–∞—Ä–∞–∑."

–î–û–°–¢–ê–í–ö–ê:
- –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º - –ù–æ–≤–∞ –ü–æ—à—Ç–∞
- –ó–∞ –∑–∞–ø–∏—Ç–æ–º –∫–ª—ñ—î–Ω—Ç–∞ - –£–∫—Ä–ø–æ—à—Ç–∞
- –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –ø—Ä–æ—Ç—è–≥–æ–º 3 –¥–Ω—ñ–≤
- –ù–µ —Ç–µ–ª–µ—Ñ–æ–Ω—É—î–º–æ –ø—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏

–ö–û–ù–¢–ê–ö–¢–ò (–¥–∞–≤–∞–π —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–ª—ñ—î–Ω—Ç –ø–∏—Ç–∞—î):
üì± –¢–µ–ª–µ—Ñ–æ–Ω: 067-392-06-82
üí¨ Telegram: @zerschikov
üåê –°–∞–π—Ç: zerschikov.online

YOUTUBE –ö–ê–ù–ê–õ (–ø—Ä–æ–ø–æ–Ω—É–π –ü–Ü–°–õ–Ø –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó –∞–±–æ –æ–ø–ª–∞—Ç–∏):
üì∫ YouTube: https://www.youtube.com/@instructor_zerschikov
"–î–æ —Ä–µ—á—ñ, —É –û–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ —î —á—É–¥–æ–≤–∏–π YouTube –∫–∞–Ω–∞–ª –∑ –∫–æ—Ä–∏—Å–Ω–∏–º–∏ –ø–æ—Ä–∞–¥–∞–º–∏ –ø—Ä–æ –≤–æ–¥—ñ–Ω–Ω—è! –ü—ñ–¥–ø–∏—à—ñ—Ç—å—Å—è, —â–æ–± –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –Ω–æ–≤—ñ –≤—ñ–¥–µ–æ: https://www.youtube.com/@instructor_zerschikov üé•"

–ü–†–ê–í–ò–õ–ê:
‚úÖ –ë—É–¥—å –¥—Ä—É–∂–Ω—ñ–º —ñ –¥–æ–ø–æ–º–∞–≥–∞–π –æ–±—Ä–∞—Ç–∏ –∫—É—Ä—Å
‚úÖ –ù–µ –≤–∏–≥–∞–¥—É–π —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é - —î —Ç—ñ–ª—å–∫–∏ —Ç–µ, —â–æ –≤–∫–∞–∑–∞–Ω–æ –≤–∏—â–µ
‚úÖ –ó–∞–≤–∂–¥–∏ –¥–∞–≤–∞–π –ø—Ä—è–º–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –æ–ø–ª–∞—Ç—É, –∫–æ–ª–∏ –∫–ª—ñ—î–Ω—Ç –≥–æ—Ç–æ–≤–∏–π
‚úÖ –î–ª—è –∑–æ—à–∏—Ç—ñ–≤ –û–ë–û–í'–Ø–ó–ö–û–í–û –ø–∏—Ç–∞–π –∞–¥—Ä–µ—Å—É –¥–æ—Å—Ç–∞–≤–∫–∏
‚úÖ –ü—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ –ø—Ä–æ–ø–æ–Ω—É–π YouTube
‚úÖ –Ø–∫—â–æ –Ω–µ –∑–Ω–∞—î—à –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ - –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π –Ω–∞–ø–∏—Å–∞—Ç–∏ –û–ª–µ–∫—Å–∞–Ω–¥—Ä—É –æ—Å–æ–±–∏—Å—Ç–æ

–°–¢–ò–õ–¨ –°–ü–Ü–õ–ö–£–í–ê–ù–ù–Ø:
- –î—Ä—É–∂–Ω—ñ–π, –∞–ª–µ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π
- –ù–∞ "—Ç–∏" (–Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω–æ)
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –µ–º–æ–¥–∑—ñ –ø–æ–º—ñ—Ä–Ω–æ (1-2 –Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è)
- –ü–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –∞–±–∑–∞—Ü–∞–º–∏ –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ —á–∏—Ç–∞–Ω–Ω—è
- –ù–µ –ø–æ–≤—Ç–æ—Ä—é–π –æ–¥–Ω—É –π —Ç—É —Å–∞–º—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤`;

// ============================================
// –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
// ============================================

const bot = new TelegramBot(TELEGRAM_BOT_TOKEN, { polling: true });
const openai = new OpenAI({ apiKey: OPENAI_API_KEY });

// –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó –¥—ñ–∞–ª–æ–≥—ñ–≤
const conversations = new Map();

// ============================================
// –§–£–ù–ö–¶–Ü–á
// ============================================

// –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –¥—ñ–∞–ª–æ–≥—É
function getConversationHistory(chatId) {
  if (!conversations.has(chatId)) {
    conversations.set(chatId, [
      { role: 'system', content: SYSTEM_PROMPT }
    ]);
  }
  return conversations.get(chatId);
}

// –í—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ AI
async function getAIResponse(chatId, userMessage) {
  const history = getConversationHistory(chatId);
  
  // –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  history.push({ role: 'user', content: userMessage });
  
  try {
    const response = await openai.chat.completions.create({
      model: 'gpt-4',
      messages: history,
      temperature: 0.7,
      max_tokens: 1500
    });
    
    const aiMessage = response.choices[0].message.content;
    
    // –î–æ–¥–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å AI –≤ —ñ—Å—Ç–æ—Ä—ñ—é
    history.push({ role: 'assistant', content: aiMessage });
    
    // –û–±–º–µ–∂—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é (–æ—Å—Ç–∞–Ω–Ω—ñ 20 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å)
    if (history.length > 21) {
      conversations.set(chatId, [
        history[0], // –°–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç
        ...history.slice(-20)
      ]);
    }
    
    return aiMessage;
  } catch (error) {
    console.error('OpenAI Error:', error);
    
    if (error.code === 'insufficient_quota') {
      return '–í–∏–±–∞—á—Ç–µ, —É –±–æ—Ç–∞ –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è –ª—ñ–º—ñ—Ç –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ AI. –ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–ø–∏—à—ñ—Ç—å –Ω–∞–ø—Ä—è–º—É @zerschikov';
    }
    
    return '–í–∏–±–∞—á—Ç–µ, –≤–∏–Ω–∏–∫–ª–∞ —Ç–∏–º—á–∞—Å–æ–≤–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –Ω–∞–ø–∏—à—ñ—Ç—å @zerschikov';
  }
}

// –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—É –ø—Ä–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
function notifyAdmin(orderInfo) {
  const message = `
üîî –ù–û–í–ï –ó–ê–ú–û–í–õ–ï–ù–ù–Ø!

üë§ –ö–ª—ñ—î–Ω—Ç: ${orderInfo.username}
üì± Chat ID: ${orderInfo.chatId}

üí¨ –û—Å—Ç–∞–Ω–Ω—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:
"${orderInfo.userMessage}"

ü§ñ –í—ñ–¥–ø–æ–≤—ñ–¥—å –±–æ—Ç–∞:
"${orderInfo.botResponse.substring(0, 200)}..."

‚è∞ –ß–∞—Å: ${new Date().toLocaleString('uk-UA', { timeZone: 'Europe/Kiev' })}
  `.trim();
  
  bot.sendMessage(ADMIN_CHAT_ID, message).catch(err => {
    console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—É:', err);
  });
}

// –†–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ —á–∏ —î –≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –æ–ø–ª–∞—Ç—É
function containsPaymentLink(message) {
  return message.includes('wayforpay.com/button/');
}

// ============================================
// –û–ë–†–û–ë–ù–ò–ö–ò –ö–û–ú–ê–ù–î
// ============================================

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  const firstName = msg.from.first_name || '–¥—Ä—É–∂–µ';
  
  const welcomeMessage = `
–ü—Ä–∏–≤—ñ—Ç, ${firstName}! üëã

–Ø - AI-–ø–æ–º—ñ—á–Ω–∏–∫ –û–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –ó—î—Ä—â–∏–∫–æ–≤–∞, –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–æ–≥–æ —ñ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –∑ –≤–æ–¥—ñ–Ω–Ω—è.

üìö –î–æ–ø–æ–º–æ–∂—É —Ç–æ–±—ñ:
‚Ä¢ –û–±—Ä–∞—Ç–∏ –∫—É—Ä—Å –¥–ª—è –Ω–∞–≤—á–∞–Ω–Ω—è –≤–æ–¥—ñ–Ω–Ω—é
‚Ä¢ –†–æ–∑–ø–æ–≤—ñ—Å—Ç–∏ –ø—Ä–æ –∫–æ–∂–µ–Ω –ø—Ä–æ–¥—É–∫—Ç –¥–µ—Ç–∞–ª—å–Ω–æ
‚Ä¢ –û—Ñ–æ—Ä–º–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –æ–ø–ª–∞—Ç—É

üéØ –£ –Ω–∞—Å —î:
‚Ä¢ –ö—É—Ä—Å "–ü–î–† –∑–∞ 220 —Ö–≤–∏–ª–∏–Ω" (–≤—ñ–¥ 880 –≥—Ä–Ω)
‚Ä¢ –ö—É—Ä—Å "10 –∫—Ä–æ–∫—ñ–≤ –¥–æ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ–≥–æ –≤–æ–¥—ñ–Ω–Ω—è" (–≤—ñ–¥ 580 –≥—Ä–Ω)
‚Ä¢ –ö—É—Ä—Å "–ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ—ó–∑–¥—É –ø–µ—Ä–µ—Ö—Ä–µ—Å—Ç—å" (480 –≥—Ä–Ω)
‚Ä¢ –†–æ–∑—É–º–Ω–∏–π –∑–æ—à–∏—Ç –∑ –ø—Ä–∞–∫—Ç–∏–∫–∏ (360 –≥—Ä–Ω)
‚Ä¢ –†–æ–±–æ—á–∏–π –∑–æ—à–∏—Ç –∑ —Ç–µ–æ—Ä—ñ—ó –ü–î–† (370 –≥—Ä–Ω)

–©–æ —Ç–µ–±–µ —Ü—ñ–∫–∞–≤–∏—Ç—å? –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ —Å–≤–æ—î –ø–∏—Ç–∞–Ω–Ω—è! üí¨
  `.trim();
  
  bot.sendMessage(chatId, welcomeMessage);
  
  // –û—á–∏—â–∞—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
  conversations.delete(chatId);
});

// –ö–æ–º–∞–Ω–¥–∞ /menu - –ø–æ–∫–∞–∑–∞—Ç–∏ –∫–∞—Ç–∞–ª–æ–≥
bot.onText(/\/menu/, (msg) => {
  const chatId = msg.chat.id;
  
  const menuMessage = `
üìö –ö–ê–¢–ê–õ–û–ì –ü–†–û–î–£–ö–¢–Ü–í

üéì –û–ù–õ–ê–ô–ù –ö–£–†–°–ò:

1Ô∏è‚É£ –ü–î–† –∑–∞ 220 —Ö–≤–∏–ª–∏–Ω
   üí∞ –í—ñ–¥ 880 –≥—Ä–Ω | ‚è± –®–≤–∏–¥–∫–µ —Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–µ –≤–∏–≤—á–µ–Ω–Ω—è
   üìä 1200+ —É—á–Ω—ñ–≤ | ‚≠êÔ∏è 4.9/5

2Ô∏è‚É£ 10 –∫—Ä–æ–∫—ñ–≤ –¥–æ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ–≥–æ –≤–æ–¥—ñ–Ω–Ω—è
   üí∞ –í—ñ–¥ 580 –≥—Ä–Ω | üöó –í—ñ–¥ —Ä—É—à–∞–Ω–Ω—è –¥–æ –ø–∞—Ä–∫—É–≤–∞–Ω–Ω—è
   üë• –î–ª—è –ø–æ—á–∞—Ç–∫—ñ–≤—Ü—ñ–≤ —Ç–∞ –ø—ñ—Å–ª—è –ø–µ—Ä–µ—Ä–≤–∏

3Ô∏è‚É£ –ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ—ó–∑–¥—É –ø–µ—Ä–µ—Ö—Ä–µ—Å—Ç—å
   üí∞ 480 –≥—Ä–Ω | üö¶ –ß—ñ—Ç–∫–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º –Ω–∞ –ø–µ—Ä–µ—Ö—Ä–µ—Å—Ç—ñ
   üé• 6 –¥–µ—Ç–∞–ª—å–Ω–∏—Ö –≤—ñ–¥–µ–æ–ª–µ–∫—Ü—ñ–π

üìì –î–†–£–ö–û–í–ê–ù–Ü –ó–û–®–ò–¢–ò:

4Ô∏è‚É£ –†–æ–∑—É–º–Ω–∏–π –∑–æ—à–∏—Ç - 360 –≥—Ä–Ω
   üìÑ 120 –∫–æ–ª—å–æ—Ä–æ–≤–∏—Ö —Å—Ç–æ—Ä—ñ–Ω–æ–∫ –∑ –∑–∞–≤–¥–∞–Ω–Ω—è–º–∏
   üì¶ –î–æ—Å—Ç–∞–≤–∫–∞ –ù–æ–≤–æ—é –ü–æ—à—Ç–æ—é –∑–∞ 3 –¥–Ω—ñ

5Ô∏è‚É£ –†–æ–±–æ—á–∏–π –∑–æ—à–∏—Ç –∑ —Ç–µ–æ—Ä—ñ—ó –ü–î–† - 370 –≥—Ä–Ω
   üìù –°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –≤–∏–≤—á–µ–Ω–Ω—è
   üéØ –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ —ñ—Å–ø–∏—Ç—É –≤ –ú–í–°

–ù–∞–ø–∏—à–∏ –Ω–æ–º–µ—Ä –ø—Ä–æ–¥—É–∫—Ç—É –∞–±–æ –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏, —â–æ —Ç–µ–±–µ —Ü—ñ–∫–∞–≤–∏—Ç—å! üéØ
  `.trim();
  
  bot.sendMessage(chatId, menuMessage);
});

// –ö–æ–º–∞–Ω–¥–∞ /contact - –∫–æ–Ω—Ç–∞–∫—Ç–∏
bot.onText(/\/contact/, (msg) => {
  const chatId = msg.chat.id;
  
  const contactMessage = `
üìû –ö–û–ù–¢–ê–ö–¢–ò

üë®‚Äçüè´ –û–ª–µ–∫—Å–∞–Ω–¥—Ä –ó—î—Ä—â–∏–∫–æ–≤
–ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∑ –≤–æ–¥—ñ–Ω–Ω—è

üì± –¢–µ–ª–µ—Ñ–æ–Ω: 067-392-06-82
üí¨ Telegram: @zerschikov

üåê –°–∞–π—Ç: zerschikov.online
üì∫ YouTube: https://www.youtube.com/@instructor_zerschikov

–Ø–∫—â–æ —É —Ç–µ–±–µ —Å–∫–ª–∞–¥–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è –∞–±–æ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è - –ø–∏—à–∏ –Ω–∞–ø—Ä—è–º—É –û–ª–µ–∫—Å–∞–Ω–¥—Ä—É!
  `.trim();
  
  bot.sendMessage(chatId, contactMessage);
});

// –ö–æ–º–∞–Ω–¥–∞ /help
bot.onText(/\/help/, (msg) => {
  const chatId = msg.chat.id;
  
  const helpMessage = `
‚ùì –Ø–ö –ö–û–†–ò–°–¢–£–í–ê–¢–ò–°–Ø –ë–û–¢–û–ú

–ü—Ä–æ—Å—Ç–æ –ø–∏—à–∏ –º–µ–Ω—ñ —è–∫ –∑–≤–∏—á–∞–π–Ω–æ–º—É –ø–æ–º—ñ—á–Ω–∏–∫—É! üí¨

–ü—Ä–∏–∫–ª–∞–¥–∏ –ø–∏—Ç–∞–Ω—å:
‚Ä¢ "–•–æ—á—É –≤–∏–≤—á–∏—Ç–∏ –ü–î–† –∑ –Ω—É–ª—è"
‚Ä¢ "–Ø–∫–∞ —Ä—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ —Ç–∞—Ä–∏—Ñ–∞–º–∏ Pro —Ç–∞ –ü—Ä–µ–º—ñ—É–º?"
‚Ä¢ "–ú–µ–Ω—ñ –ø–æ—Ç—Ä—ñ–±–µ–Ω –∫—É—Ä—Å –¥–ª—è –ø—Ä–∞–∫—Ç–∏—á–Ω–æ–≥–æ –≤–æ–¥—ñ–Ω–Ω—è"
‚Ä¢ "–°–∫—ñ–ª—å–∫–∏ –∫–æ—à—Ç—É—î –†–æ–∑—É–º–Ω–∏–π –∑–æ—à–∏—Ç?"
‚Ä¢ "–Ø–∫ —à–≤–∏–¥–∫–æ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç–µ –∑–æ—à–∏—Ç–∏?"

üìå –ö–æ–º–∞–Ω–¥–∏:
/start - –ü–æ—á–∞—Ç–∏ —Å–ø–æ—á–∞—Ç–∫—É
/menu - –ö–∞—Ç–∞–ª–æ–≥ –≤—Å—ñ—Ö –ø—Ä–æ–¥—É–∫—Ç—ñ–≤
/contact - –ö–æ–Ω—Ç–∞–∫—Ç–∏ –û–ª–µ–∫—Å–∞–Ω–¥—Ä–∞
/help - –¶—è –¥–æ–≤—ñ–¥–∫–∞

–Ø —Ä–æ–∑—É–º—ñ—é –ø—Ä–∏—Ä–æ–¥–Ω—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è —Ç–∞ –¥–æ–ø–æ–º–æ–∂—É –æ–±—Ä–∞—Ç–∏ –Ω–∞–π–∫—Ä–∞—â–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –¥–ª—è —Ç–µ–±–µ! üéØ
  `.trim();
  
  bot.sendMessage(chatId, helpMessage);
});

// ============================================
// –û–ë–†–û–ë–ö–ê –ó–í–ò–ß–ê–ô–ù–ò–• –ü–û–í–Ü–î–û–ú–õ–ï–ù–¨
// ============================================

bot.on('message', async (msg) => {
  // –Ü–≥–Ω–æ—Ä—É—î–º–æ –∫–æ–º–∞–Ω–¥–∏ (–≤–æ–Ω–∏ –æ–±—Ä–æ–±–ª–µ–Ω—ñ –≤–∏—â–µ)
  if (msg.text && msg.text.startsWith('/')) return;
  
  const chatId = msg.chat.id;
  const userMessage = msg.text;
  
  if (!userMessage) return;
  
  // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä "–¥—Ä—É–∫—É—î..."
  bot.sendChatAction(chatId, 'typing');
  
  try {
    // –û—Ç—Ä–∏–º—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ AI
    const aiResponse = await getAIResponse(chatId, userMessage);
    
    // –ù–∞–¥—Å–∏–ª–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
    await bot.sendMessage(chatId, aiResponse, {
      disable_web_page_preview: false
    });
    
    // –Ø–∫—â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º—ñ—Å—Ç–∏—Ç—å –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –æ–ø–ª–∞—Ç—É - —Å–ø–æ–≤—ñ—â–∞—î–º–æ –∞–¥–º—ñ–Ω–∞
    if (containsPaymentLink(aiResponse)) {
      const username = msg.from.username 
        ? `@${msg.from.username}` 
        : `${msg.from.first_name || ''} ${msg.from.last_name || ''}`.trim();
      
      notifyAdmin({
        chatId,
        username,
        userMessage,
        botResponse: aiResponse
      });
    }
    
  } catch (error) {
    console.error('Bot Error:', error);
    
    let errorMessage = '–í–∏–±–∞—á—Ç–µ, —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑ –∞–±–æ –Ω–∞–ø–∏—à—ñ—Ç—å @zerschikov';
    
    if (error.response && error.response.body) {
      console.error('Telegram API Error:', error.response.body);
    }
    
    bot.sendMessage(chatId, errorMessage);
  }
});

// ============================================
// –ó–ê–ü–£–°–ö –ë–û–¢–ê
// ============================================

console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
console.log('‚ïë  ü§ñ TELEGRAM –ë–û–¢ –ó–ê–ü–£–©–ï–ù–û!         ‚ïë');
console.log('‚ïë                                      ‚ïë');
console.log('‚ïë  üë®‚Äçüè´ –û–ª–µ–∫—Å–∞–Ω–¥—Ä –ó—î—Ä—â–∏–∫–æ–≤            ‚ïë');
console.log('‚ïë  üìö –ü—Ä–æ–¥–∞–∂ –æ–Ω–ª–∞–π–Ω-–∫—É—Ä—Å—ñ–≤           ‚ïë');
console.log('‚ïë                                      ‚ïë');
console.log('‚ïë  ‚úÖ AI: –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ                  ‚ïë');
console.log('‚ïë  ‚úÖ Telegram: –ê–∫—Ç–∏–≤–Ω–∏–π              ‚ïë');
console.log('‚ïë  üëã –û—á—ñ–∫—É—é –Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...      ‚ïë');
console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');

// –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
bot.on('polling_error', (error) => {
  console.error('‚ùå Polling error:', error.code, error.message);
});

process.on('uncaughtException', (error) => {
  console.error('‚ùå Uncaught Exception:', error);
});

process.on('unhandledRejection', (error) => {
  console.error('‚ùå Unhandled Rejection:', error);
});
